services:
  vscode-server:
    image: lscr.io/linuxserver/code-server:latest
    container_name: vscode-server
    restart: "no"

    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - PASSWORD=${PASSWORD}
      - SUDO_PASSWORD=${SUDO_PASSWORD}

      # MCP server URLs (using container names)
      - MCP_GITHUB_URL=${MCP_GITHUB_URL}
      - MCP_OPENAI_URL=${MCP_OPENAI_URL}
      - MCP_GMAIL_URL=${MCP_GMAIL_URL}
      - MCP_GDRIVE_URL=${MCP_GDRIVE_URL}
      - MCP_MEMORY_URL=${MCP_MEMORY_URL}
      - MCP_PLAYWRIGHT_URL=${MCP_PLAYWRIGHT_URL}

    volumes:
      - /mnt/user/appdata/vscode-server/config:/config
      - /mnt/user/appdata/vscode-server/workspace:/config/workspace
      - /var/run/docker.sock:/var/run/docker.sock

    ports:
      - "8090:8443"

    networks:
      - mcp_network
      - my_internal_network

    # Install development tools using a custom script
    entrypoint: /bin/bash
    command:
      - -c
      - |
        set -e
        echo "Installing development tools..."

        # Update and install all packages
        apt-get update
        apt-get install -y bash-completion git git-lfs curl wget vim nano
        apt-get install -y build-essential gcc g++ gdb make cmake automake autoconf pkg-config libtool
        apt-get install -y python3 python3-pip python3-dev python3-venv
        apt-get install -y nodejs npm
        apt-get install -y docker.io docker-compose
        apt-get install -y openssh-client ca-certificates gnupg lsb-release
        apt-get install -y software-properties-common apt-transport-https
        apt-get install -y jq zip unzip tar gzip bzip2 xz-utils tree htop sudo

        # Install yq separately
        wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        chmod +x /usr/local/bin/yq

        # Install Python packages (ignore system packages to avoid conflicts)
        pip3 install --break-system-packages --ignore-installed jupyter jupyterlab ipython
        pip3 install --break-system-packages --ignore-installed pandas numpy scipy matplotlib seaborn scikit-learn
        pip3 install --break-system-packages --ignore-installed requests httpx aiohttp
        pip3 install --break-system-packages --ignore-installed fastapi uvicorn flask django
        pip3 install --break-system-packages --ignore-installed sqlalchemy psycopg2-binary
        pip3 install --break-system-packages --ignore-installed pytest pytest-cov black flake8 mypy pylint
        pip3 install --break-system-packages --ignore-installed poetry pipenv virtualenv

        # Install Claude Code CLI globally
        npm install -g claude-code

        # Install additional Node.js tools
        npm install -g typescript ts-node prettier eslint yarn pnpm

        # Fix docker group (may already exist)
        groupmod -g 999 docker 2>/dev/null || groupadd -g 999 docker || true
        usermod -aG docker abc 2>/dev/null || true

        # Set up bash completion
        echo 'if [ -f /etc/bash_completion ]; then . /etc/bash_completion; fi' >> /config/.bashrc
        echo 'alias ll="ls -lah"' >> /config/.bashrc

        echo ""
        echo "========================================"
        echo "‚úÖ VSCode Server Ready!"
        echo "========================================"
        echo "Access: http://100.78.183.119:8090"
        echo "User: abc (non-root, UID 1000)"
        echo ""
        echo "üåê Networks:"
        echo "  ‚Ä¢ mcp_network (MCP communication)"
        echo "  ‚Ä¢ my_internal_network (custom)"
        echo ""
        echo "üì¶ Installed Tools:"
        echo "  ‚Ä¢ bash, git, curl, wget, vim"
        echo "  ‚Ä¢ gcc, g++, make, cmake"
        echo "  ‚Ä¢ Python 3 + data science packages"
        echo "  ‚Ä¢ Node.js + npm/yarn/pnpm"
        echo "  ‚Ä¢ Docker + Docker Compose"
        echo "  ‚Ä¢ Claude Code CLI"
        echo "  ‚Ä¢ TypeScript, Prettier, ESLint"
        echo ""
        echo "üîå MCP Servers (via container names):"
        echo "  ‚Ä¢ GitHub:    http://github-mcp-proxy:3006/sse"
        echo "  ‚Ä¢ OpenAI:    http://openai-mcp-proxy:3001/sse"
        echo "  ‚Ä¢ Gmail:     http://gmail-mcp-proxy:3102/sse"
        echo "  ‚Ä¢ Drive:     http://gdrive-mcp-proxy:3004/sse"
        echo "  ‚Ä¢ Memory:    http://memory-mcp-proxy:3107/sse"
        echo "  ‚Ä¢ Playwright: http://playwright-mcp:3008/sse"
        echo ""
        echo "ü§ñ To use Claude Code:"
        echo "  1. Open terminal in VSCode"
        echo "  2. Run: claude"
        echo "========================================"
        echo ""

        # Start code-server
        exec /init

networks:
  mcp_network:
    external: true
  my_internal_network:
    external: true
