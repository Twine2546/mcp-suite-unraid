services:
  vscode-server:
    image: lscr.io/linuxserver/code-server:latest
    container_name: vscode-server
    restart: "no"

    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - PASSWORD=${PASSWORD}
      - SUDO_PASSWORD=${SUDO_PASSWORD}

      # MCP server URLs (using container names)
      - MCP_GITHUB_URL=${MCP_GITHUB_URL}
      - MCP_OPENAI_URL=${MCP_OPENAI_URL}
      - MCP_GMAIL_URL=${MCP_GMAIL_URL}
      - MCP_GDRIVE_URL=${MCP_GDRIVE_URL}
      - MCP_MEMORY_URL=${MCP_MEMORY_URL}
      - MCP_PLAYWRIGHT_URL=${MCP_PLAYWRIGHT_URL}

    volumes:
      - /mnt/user/appdata/vscode-server/config:/config
      - /mnt/user/appdata/vscode-server/workspace:/config/workspace
      - /var/run/docker.sock:/var/run/docker.sock
      - /mnt/user/appdata/dockge/stacks/vscode-server/install-claude.sh:/install-claude.sh:ro

    ports:
      - "8090:8443"

    networks:
      - mcp_network
      - my_internal_network

    # Install development tools using a custom script
    entrypoint: /bin/bash
    command:
      - -c
      - |
        set -e

        # Check if first-time setup has been completed
        if [ ! -f /config/.setup-complete ]; then
          echo "========================================"
          echo "ðŸ”§ First-time setup detected"
          echo "Installing development tools..."
          echo "This may take 5-10 minutes"
          echo "========================================"
          echo ""

          # Update and install all packages
          apt-get update
          apt-get install -y bash-completion git git-lfs curl wget vim nano
          apt-get install -y build-essential gcc g++ gdb make cmake automake autoconf pkg-config libtool
          apt-get install -y python3 python3-pip python3-dev python3-venv
          apt-get install -y nodejs npm
          apt-get install -y docker.io docker-compose
          apt-get install -y openssh-client ca-certificates gnupg lsb-release
          apt-get install -y software-properties-common apt-transport-https
          apt-get install -y jq zip unzip tar gzip bzip2 xz-utils tree htop sudo

          # Install yq separately
          wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq

          # Install Python packages (ignore system packages to avoid conflicts)
          pip3 install --break-system-packages --ignore-installed jupyter jupyterlab ipython
          pip3 install --break-system-packages --ignore-installed pandas numpy scipy matplotlib seaborn scikit-learn
          pip3 install --break-system-packages --ignore-installed requests httpx aiohttp
          pip3 install --break-system-packages --ignore-installed fastapi uvicorn flask django
          pip3 install --break-system-packages --ignore-installed sqlalchemy psycopg2-binary
          pip3 install --break-system-packages --ignore-installed pytest pytest-cov black flake8 mypy pylint
          pip3 install --break-system-packages --ignore-installed poetry pipenv virtualenv

          # Install Claude Code CLI using separate script
          echo ""
          echo "Running Claude Code installation script..."
          bash /install-claude.sh

          # Install additional Node.js tools
          npm install -g typescript ts-node prettier eslint yarn pnpm

          # Fix docker group (may already exist)
          groupmod -g 999 docker 2>/dev/null || groupadd -g 999 docker || true
          usermod -aG docker abc 2>/dev/null || true

          # Set up bash completion
          echo 'if [ -f /etc/bash_completion ]; then . /etc/bash_completion; fi' >> /config/.bashrc
          echo 'alias ll="ls -lah"' >> /config/.bashrc

          # Mark setup as complete
          touch /config/.setup-complete
          echo ""
          echo "âœ… First-time setup complete!"
        else
          echo "â© Skipping setup - already configured"
          echo "   (Remove /config/.setup-complete to reinstall)"
        fi

        # Fix permissions for Claude Code (run every time)
        echo "ðŸ”§ Fixing Claude Code permissions..."
        mkdir -p /config/.claude
        chown -R abc:abc /config/.claude
        chown abc:abc /config/.claude.json 2>/dev/null || true
        chown abc:abc /config/.claude.json.backup 2>/dev/null || true

        # Configure VSCode settings for performance
        echo "ðŸ”§ Configuring VSCode settings..."
        mkdir -p /config/data/User
        cat > /config/data/User/settings.json << 'SETTINGS'
{
  "workbench.colorTheme": "Default Dark+",
  "editor.fontSize": 14,
  "terminal.integrated.fontSize": 14,
  "editor.minimap.enabled": true,
  "editor.wordWrap": "on",
  "files.autoSave": "afterDelay",
  "files.autoSaveDelay": 1000,
  "security.workspace.trust.enabled": false,
  
  "editor.copyWithSyntaxHighlighting": false,
  "terminal.integrated.copyOnSelection": true,
  "terminal.integrated.rightClickBehavior": "default",
  
  "git.enabled": true,
  "git.autorefresh": false,
  "git.autofetch": false,
  "files.watcherExclude": {
    "**/.git/objects/**": true,
    "**/.git/subtree-cache/**": true,
    "**/node_modules/**": true,
    "**/.hg/store/**": true
  },
  "search.followSymlinks": false,
  "extensions.autoUpdate": false
}
SETTINGS
        chown abc:abc /config/data/User/settings.json

        echo ""
        echo "========================================"
        echo "âœ… VSCode Server Ready!"
        echo "========================================"
        echo "Access via your server's IP on port 8090"
        echo "User: abc (non-root, UID 1000)"
        echo ""
        echo "ðŸŒ Networks:"
        echo "  â€¢ mcp_network (MCP communication)"
        echo "  â€¢ my_internal_network (custom)"
        echo ""
        echo "ðŸ“¦ Installed Tools:"
        echo "  â€¢ bash, git, curl, wget, vim"
        echo "  â€¢ gcc, g++, make, cmake"
        echo "  â€¢ Python 3 + data science packages"
        echo "  â€¢ Node.js + npm/yarn/pnpm"
        echo "  â€¢ Docker + Docker Compose"
        echo "  â€¢ Claude Code CLI"
        echo "  â€¢ TypeScript, Prettier, ESLint"
        echo ""
        echo "ðŸ”Œ MCP Servers (via container names):"
        echo "  â€¢ GitHub:    http://github-mcp-proxy:3006/sse"
        echo "  â€¢ OpenAI:    http://openai-mcp-proxy:3001/sse"
        echo "  â€¢ Gmail:     http://gmail-mcp-proxy:3102/sse"
        echo "  â€¢ Drive:     http://gdrive-mcp-proxy:3004/sse"
        echo "  â€¢ Memory:    http://memory-mcp-proxy:3107/sse"
        echo "  â€¢ Playwright: http://playwright-mcp:3008/sse"
        echo ""
        echo "ðŸ¤– To use Claude Code:"
        echo "  1. Open terminal in VSCode"
        echo "  2. Run: claude"
        echo ""
        echo "ðŸ“‹ Clipboard: Use browser flags for best experience (see docs)"
        echo "========================================"
        echo ""

        # Start code-server
        exec /init

networks:
  mcp_network:
    external: true
  my_internal_network:
    external: true
